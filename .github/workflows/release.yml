name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          # èŽ·å–å½“å‰æ ‡ç­¾å’Œå‰ä¸€ä¸ªæ ‡ç­¾
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "$CURRENT_TAG^" 2>/dev/null || echo "")

          echo "å½“å‰æ ‡ç­¾: $CURRENT_TAG"
          echo "å‰ä¸€ä¸ªæ ‡ç­¾: $PREVIOUS_TAG"

          # ç”Ÿæˆæ›´æ–°æ—¥å¿—
          {
            echo "## ðŸš€ æ›´æ–°å†…å®¹"
            echo ""

            if [ -z "$PREVIOUS_TAG" ]; then
              echo "### âœ¨ æ–°åŠŸèƒ½"
              git log --pretty=format:"- %s (%h)" --no-merges | head -20
            else
              # æå–åŠŸèƒ½å˜æ›´
              echo "### âœ¨ æ–°åŠŸèƒ½"
              git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%s" --no-merges | \
                grep -iE "^feat|^feature" | sed 's/^feat\(.*\): /- /' | sed 's/^feature\(.*\): /- /' || echo "- æ— æ–°åŠŸèƒ½"

              echo ""
              echo "### ðŸ› Bug ä¿®å¤"
              git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%s" --no-merges | \
                grep -iE "^fix|^bugfix" | sed 's/^fix\(.*\): /- /' | sed 's/^bugfix\(.*\): /- /' || echo "- æ—  Bug ä¿®å¤"

              echo ""
              echo "### ðŸ“š æ–‡æ¡£æ›´æ–°"
              git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%s" --no-merges | \
                grep -iE "^docs|^doc" | sed 's/^docs\(.*\): /- /' | sed 's/^doc\(.*\): /- /' || echo "- æ— æ–‡æ¡£æ›´æ–°"

              echo ""
              echo "### â™»ï¸ ä»£ç é‡æž„"
              git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%s" --no-merges | \
                grep -iE "^refactor" | sed 's/^refactor\(.*\): /- /' || echo "- æ— é‡æž„"

              echo ""
              echo "### ðŸŽ¨ æ ·å¼ä¼˜åŒ–"
              git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%s" --no-merges | \
                grep -iE "^style|^ui" | sed 's/^style\(.*\): /- /' | sed 's/^ui\(.*\): /- /' || echo "- æ— æ ·å¼ä¼˜åŒ–"
            fi

            echo ""
            echo "---"
            echo ""
            echo "## ðŸ³ Docker é•œåƒ"
            echo ""
            echo "### æ‹‰å–é•œåƒ"
            echo '```bash'
            echo "# åŽç«¯é•œåƒ"
            echo "docker pull shanheee/easyssh-backend:$CURRENT_TAG"
            echo "docker pull shanheee/easyssh-backend:latest"
            echo ""
            echo "# å‰ç«¯é•œåƒ"
            echo "docker pull shanheee/easyssh-frontend:$CURRENT_TAG"
            echo "docker pull shanheee/easyssh-frontend:latest"
            echo '```'
            echo ""
            echo "### æ”¯æŒæž¶æž„"
            echo "- \`linux/amd64\`"
            echo "- \`linux/arm64\`"
            echo ""
            echo "## ðŸ“¦ å¿«é€Ÿéƒ¨ç½²"
            echo ""
            echo "### Docker Compose"
            echo '```bash'
            echo "# ä¸‹è½½ docker-compose.yml"
            echo "wget https://raw.githubusercontent.com/shan-hee/EasySSH-NextJS/$CURRENT_TAG/docker/docker-compose.yml"
            echo ""
            echo "# ä¿®æ”¹é…ç½®"
            echo "vi docker-compose.yml"
            echo ""
            echo "# å¯åŠ¨æœåŠ¡"
            echo "docker-compose up -d"
            echo '```'
            echo ""
            echo "### Docker Compose éƒ¨ç½²ï¼ˆæŽ¨èï¼‰"
            echo '```bash'
            echo "# ä½¿ç”¨ docker-compose.yml"
            echo "cd docker"
            echo "docker compose up -d"
            echo '```'
            echo ""
            echo "### ç‹¬ç«‹è¿è¡Œ"
            echo '```bash'
            echo "# åŽç«¯"
            echo "docker run -d \\"
            echo "  --name easyssh-backend \\"
            echo "  -p 8521:8521 \\"
            echo "  -e DB_HOST=your-postgres-host \\"
            echo "  -e REDIS_HOST=your-redis-host \\"
            echo "  shanheee/easyssh-backend:$CURRENT_TAG"
            echo ""
            echo "# å‰ç«¯"
            echo "docker run -d \\"
            echo "  --name easyssh-frontend \\"
            echo "  -p 8520:8520 \\"
            echo "  -e NEXT_PUBLIC_API_BASE=http://backend:8521 \\"
            echo "  shanheee/easyssh-frontend:$CURRENT_TAG"
            echo '```'
            echo ""
            echo "## ðŸ“– æ–‡æ¡£"
            echo ""
            echo "- [éƒ¨ç½²æ–‡æ¡£](https://github.com/shan-hee/EasySSH-NextJS/blob/main/docs/deployment.md)"
            echo "- [çŽ¯å¢ƒå˜é‡é…ç½®](https://github.com/shan-hee/EasySSH-NextJS/blob/main/.env.example)"
            echo "- [æ›´æ–°æ—¥å¿—](https://github.com/shan-hee/EasySSH-NextJS/releases)"
            echo ""
            echo "## ðŸ”’ å®‰å…¨"
            echo ""
            echo "æ‰€æœ‰é•œåƒå·²é€šè¿‡ Trivy å®‰å…¨æ‰«æã€‚æŸ¥çœ‹ [Security](https://github.com/shan-hee/EasySSH-NextJS/security) æ ‡ç­¾é¡µäº†è§£è¯¦æƒ…ã€‚"
            echo ""
            echo "---"
            echo ""
            echo "**å®Œæ•´æ›´æ–°æ—¥å¿—:** [\`$PREVIOUS_TAG...$CURRENT_TAG\`](https://github.com/shan-hee/EasySSH-NextJS/compare/$PREVIOUS_TAG...$CURRENT_TAG)"
          } > release_notes.md

          cat release_notes.md

      - name: ðŸŽ‰ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: false
          files: |
            docker/docker-compose.yml
            .env.example
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š ç”Ÿæˆæ‘˜è¦
        run: |
          echo "## âœ… Release åˆ›å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** \`${GITHUB_REF#refs/tags/}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æŸ¥çœ‹ Release:** [ç‚¹å‡»è¿™é‡Œ](https://github.com/shan-hee/EasySSH-NextJS/releases/tag/${GITHUB_REF#refs/tags/})" >> $GITHUB_STEP_SUMMARY
